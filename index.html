<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pairadice — Mission Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #03050f;
    --bg2: #070d1e;
    --bg3: #0c1428;
    --border: #112040;
    --border2: #1a3060;
    --accent: #00e5ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --text: #e2eeff;
    --muted: #4a6080;
    --muted2: #2a3a55;
    --working: #10b981;
    --idle: #4a6080;
    --error: #ef4444;
    --warn: #f59e0b;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Glow orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    z-index: 0;
    animation: drift 8s ease-in-out infinite alternate;
  }
  .orb1 { width:400px; height:400px; background:rgba(0,229,255,0.04); top:-100px; right:-100px; }
  .orb2 { width:300px; height:300px; background:rgba(124,58,237,0.05); bottom:-50px; left:-50px; animation-delay:-4s; }

  @keyframes drift { from{transform:translate(0,0)} to{transform:translate(20px,20px)} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes spin { to{transform:rotate(360deg)} }
  @keyframes slideDown { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
  @keyframes glow { 0%,100%{box-shadow:0 0 4px currentColor} 50%{box-shadow:0 0 12px currentColor} }
  @keyframes scanline {
    0%{transform:translateY(-100%)}
    100%{transform:translateY(100vh)}
  }

  /* Scanline effect */
  .scanline {
    position: fixed;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(0,229,255,0.08), transparent);
    pointer-events: none;
    z-index: 1;
    animation: scanline 8s linear infinite;
  }

  /* ── TOPBAR ── */
  .topbar {
    position: relative;
    z-index: 10;
    height: 52px;
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(3,5,15,0.95);
    backdrop-filter: blur(20px);
    flex-shrink: 0;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.05em;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,229,255,0.4);
  }
  .logo-icon {
    width: 28px; height: 28px;
    border: 1.5px solid var(--accent);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 0 10px rgba(0,229,255,0.2), inset 0 0 10px rgba(0,229,255,0.05);
  }
  .topbar-sub {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .spacer { flex: 1; }
  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.06em;
    border: 1px solid;
    transition: all 0.3s;
  }
  .status-pill.connected { color: var(--working); border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.08); }
  .status-pill.connecting { color: var(--warn); border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.08); }
  .status-pill.disconnected { color: var(--error); border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.08); }
  .status-dot { width:6px; height:6px; border-radius:50%; background:currentColor; animation: glow 2s infinite; }
  .status-pill.connecting .status-dot { animation: pulse 1s infinite; }

  .topbar-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 7px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid var(--border2);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    letter-spacing: 0.04em;
  }
  .topbar-btn:hover { background: rgba(0,229,255,0.06); color: var(--accent); border-color: rgba(0,229,255,0.3); }
  .topbar-btn.active { background: rgba(0,229,255,0.1); color: var(--accent); border-color: rgba(0,229,255,0.4); }

  /* ── MAIN LAYOUT ── */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }

  /* ── SIDEBAR ── */
  .sidebar {
    width: 200px;
    flex-shrink: 0;
    border-right: 1px solid var(--border);
    background: rgba(7,13,30,0.8);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    backdrop-filter: blur(12px);
  }
  .sidebar-section {
    padding: 16px 12px 8px;
    font-size: 9px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted2);
    font-weight: 500;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
    color: var(--muted);
    transition: all 0.15s;
    border-left: 2px solid transparent;
    letter-spacing: 0.02em;
  }
  .nav-item:hover { color: var(--text); background: rgba(0,229,255,0.04); }
  .nav-item.active { color: var(--accent); background: rgba(0,229,255,0.06); border-left-color: var(--accent); }
  .nav-icon { width: 16px; text-align: center; font-size: 13px; }

  .sidebar-divider { height:1px; background: var(--border); margin: 8px 0; }

  /* Agent health in sidebar */
  .sidebar-health {
    padding: 12px 16px;
    margin-top: auto;
    border-top: 1px solid var(--border);
  }
  .health-label { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted2); margin-bottom: 8px; }
  .health-metric { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:11px; }
  .health-metric .label { color: var(--muted); }
  .health-metric .val { color: var(--text); font-weight: 500; }
  .health-metric .val.good { color: var(--working); }
  .health-metric .val.warn { color: var(--warn); }
  .health-metric .val.bad { color: var(--error); }

  /* ── CONTENT AREA ── */
  .content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Page header */
  .page-header {
    padding: 16px 20px 12px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .page-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }
  .page-subtitle { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .status-badges {
    display: flex;
    gap: 12px;
    margin-left: auto;
    align-items: center;
  }
  .badge {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--muted);
  }
  .badge-dot { width:7px; height:7px; border-radius:50%; }

  /* Control strip */
  .control-strip {
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(7,13,30,0.5);
    flex-shrink: 0;
  }
  .ctrl-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 7px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    cursor: pointer;
    transition: all 0.15s;
    border: 1px solid var(--border2);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    letter-spacing: 0.04em;
  }
  .ctrl-btn:hover { transform: translateY(-1px); filter: brightness(1.2); }
  .ctrl-btn.blue { border-color: rgba(0,229,255,0.3); color: var(--accent); background: rgba(0,229,255,0.06); }
  .ctrl-btn.purple { border-color: rgba(124,58,237,0.3); color: #a78bfa; background: rgba(124,58,237,0.06); }
  .ctrl-btn.green { border-color: rgba(16,185,129,0.3); color: var(--working); background: rgba(16,185,129,0.06); }
  .ctrl-btn.amber { border-color: rgba(245,158,11,0.3); color: var(--warn); background: rgba(245,158,11,0.06); }

  /* ── PANELS ROW ── */
  .panels {
    flex: 1;
    display: flex;
    overflow: hidden;
    padding: 14px;
    gap: 12px;
  }

  /* Agent floor panel */
  .floor-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }
  .panel-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.06em;
    flex-shrink: 0;
  }
  .panel-header strong { color: var(--text); font-size: 12px; }

  /* Checkerboard office floor */
  .office-floor {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-image: repeating-conic-gradient(
      rgba(17,32,64,0.6) 0% 25%,
      rgba(12,20,40,0.6) 0% 50%
    );
    background-size: 48px 48px;
  }

  /* Agent sprite */
  .agent {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: left 1.2s cubic-bezier(0.4,0,0.2,1), top 1.2s cubic-bezier(0.4,0,0.2,1);
    z-index: 3;
  }
  .agent:hover .agent-body { filter: brightness(1.4) drop-shadow(0 0 8px var(--accent)); transform: scale(1.1); }
  .agent-body { transition: all 0.2s; }
  .agent-label {
    margin-top: 3px;
    font-size: 9px;
    letter-spacing: 0.04em;
    background: rgba(3,5,15,0.85);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1px 6px;
    color: var(--text);
    white-space: nowrap;
  }
  .agent-status-ring {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid var(--bg2);
    animation: glow 2s infinite;
  }

  /* Tooltip */
  .agent-tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 20;
    animation: slideDown 0.15s ease;
    pointer-events: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    display: none;
  }
  .agent:hover .agent-tooltip { display: block; }
  .tooltip-name { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; margin-bottom: 4px; }
  .tooltip-row { display:flex; gap:8px; color: var(--muted); }
  .tooltip-row span { color: var(--text); }

  /* Desks */
  .desk {
    position: absolute;
    z-index: 1;
    pointer-events: none;
  }

  /* ── RIGHT PANELS ── */
  .right-panels {
    width: 260px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .info-panel {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .info-panel.flex1 { flex: 1; }

  .activity-list {
    overflow-y: auto;
    flex: 1;
  }
  .activity-item {
    padding: 8px 14px;
    border-bottom: 1px solid rgba(17,32,64,0.6);
    animation: slideDown 0.3s ease;
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 3px;
  }
  .activity-agent { font-size: 12px; font-weight: 500; }
  .activity-time { font-size: 10px; color: var(--muted); margin-left: auto; }
  .activity-text { font-size: 10px; color: var(--muted); padding-left: 13px; }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    color: var(--muted2);
    font-size: 11px;
    gap: 8px;
    flex: 1;
  }
  .empty-icon { font-size: 20px; opacity: 0.4; animation: pulse 3s infinite; }

  /* Stats row */
  .stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--border);
    border-top: 1px solid var(--border);
  }
  .stat-cell {
    background: var(--bg2);
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .stat-label { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted2); }
  .stat-value { font-size: 18px; font-family: 'Syne', sans-serif; font-weight: 700; color: var(--text); }
  .stat-value.accent { color: var(--accent); }
  .stat-value.green { color: var(--working); }

  /* Session panel */
  .session-item {
    padding: 8px 14px;
    border-bottom: 1px solid rgba(17,32,64,0.6);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
  }
  .session-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
  .session-name { flex:1; color: var(--text); }
  .session-model { font-size: 9px; color: var(--muted); letter-spacing: 0.04em; }

  /* Bottom tabs */
  .bottom-tabs {
    height: 38px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 4px;
    background: rgba(3,5,15,0.95);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }
  .tab {
    padding: 4px 14px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    color: var(--muted);
    border: 1px solid transparent;
    transition: all 0.15s;
    letter-spacing: 0.03em;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-color: rgba(0,229,255,0.25); background: rgba(0,229,255,0.06); }

  /* Loading spinner */
  .spinner {
    width: 14px; height: 14px;
    border: 2px solid var(--border2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  /* Chat input panel */
  .chat-bar {
    padding: 10px 14px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    background: rgba(7,13,30,0.8);
    flex-shrink: 0;
  }
  .chat-input {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,229,255,0.1); }
  .chat-input::placeholder { color: var(--muted2); }
  .send-btn {
    padding: 8px 16px;
    background: rgba(0,229,255,0.12);
    border: 1px solid rgba(0,229,255,0.35);
    border-radius: 8px;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.04em;
  }
  .send-btn:hover { background: rgba(0,229,255,0.2); transform: translateY(-1px); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* WS message feed overlay */
  .ws-feed {
    position: absolute;
    top: 8px; right: 8px;
    width: 200px;
    max-height: 120px;
    overflow: hidden;
    z-index: 5;
    pointer-events: none;
  }
  .ws-msg {
    background: rgba(3,5,15,0.9);
    border: 1px solid var(--border2);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 9px;
    color: var(--muted);
    margin-bottom: 4px;
    animation: slideDown 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ws-msg .hi { color: var(--accent); }

  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
</style>
</head>
<body>

<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="scanline"></div>

<!-- ── TOPBAR ── -->
<div class="topbar">
  <div class="logo">
    <div class="logo-icon">⌖</div>
    PAIRADICE
  </div>
  <span class="topbar-sub">Mission Control</span>
  <div class="spacer"></div>
  <div id="connStatus" class="status-pill connecting">
    <div class="status-dot"></div>
    <span id="connLabel">Connecting...</span>
  </div>
  <button class="topbar-btn" id="pauseBtn" onclick="togglePause()">⏸ Pause</button>
  <button class="topbar-btn active" onclick="reconnect()">⟳ Reconnect</button>
</div>

<!-- ── MAIN ── -->
<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">Navigate</div>
    <div class="nav-item active" onclick="setTab('office')"><span class="nav-icon">⌂</span>Office</div>
    <div class="nav-item" onclick="setTab('sessions')"><span class="nav-icon">◈</span>Sessions</div>
    <div class="nav-item" onclick="setTab('logs')"><span class="nav-icon">≡</span>Logs</div>
    <div class="nav-item" onclick="setTab('channels')"><span class="nav-icon">⊕</span>Channels</div>
    <div class="nav-item" onclick="setTab('skills')"><span class="nav-icon">✦</span>Skills</div>
    <div class="nav-item" onclick="setTab('config')"><span class="nav-icon">⚙</span>Config</div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">Channels</div>
    <div class="nav-item"><span class="nav-icon" style="color:#5865f2">◆</span>Discord</div>
    <div class="nav-item"><span class="nav-icon" style="color:#2ca5e0">✈</span>Telegram</div>
    <div class="sidebar-health">
      <div class="health-label">System Health</div>
      <div class="health-metric">
        <span class="label">Model</span>
        <span class="val good" id="healthModel">GPT-5.1</span>
      </div>
      <div class="health-metric">
        <span class="label">Sessions</span>
        <span class="val" id="healthSessions">—</span>
      </div>
      <div class="health-metric">
        <span class="label">Uptime</span>
        <span class="val good" id="healthUptime">—</span>
      </div>
      <div class="health-metric">
        <span class="label">Gateway</span>
        <span class="val" id="healthGateway">—</span>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="page-header">
      <div>
        <div class="page-title">The Office</div>
        <div class="page-subtitle">Pairadice HQ — live view · Berlin timezone</div>
      </div>
      <div class="status-badges">
        <div class="badge"><div class="badge-dot" style="background:var(--working)"></div><span id="countWorking">0</span> working</div>
        <div class="badge"><div class="badge-dot" style="background:#60a5fa"></div><span id="countChatting">0</span> chatting</div>
        <div class="badge"><div class="badge-dot" style="background:var(--warn)"></div><span id="countIdle">0</span> idle</div>
      </div>
    </div>

    <div class="control-strip">
      <span style="font-size:11px;color:var(--muted);margin-right:8px">✦ Controls</span>
      <button class="ctrl-btn blue" onclick="sendMessage('ping')">◎ Ping Pairadice</button>
      <button class="ctrl-btn purple" onclick="sendMessage('status')">⊟ Status Check</button>
      <button class="ctrl-btn green" onclick="fetchHealth()">♥ Health</button>
      <button class="ctrl-btn amber" onclick="fetchSessions()">◈ Refresh Sessions</button>
      <div class="spacer"></div>
      <div id="lastUpdate" style="font-size:10px;color:var(--muted2)">Not connected</div>
    </div>

    <div class="panels">
      <!-- OFFICE FLOOR -->
      <div class="floor-panel">
        <div class="panel-header">
          <span>⌖</span>
          <strong>Pairadice Office</strong>
          <span style="margin-left:auto;display:flex;align-items:center;gap:6px">
            <span id="floorStatus" style="font-size:10px">Initializing...</span>
          </span>
        </div>
        <div class="office-floor" id="officeFloor">
          <!-- Desks rendered by JS -->
          <!-- WS message feed -->
          <div class="ws-feed" id="wsFeed"></div>
        </div>
        <div class="chat-bar">
          <input class="chat-input" id="chatInput" placeholder="Send message to Pairadice..." onkeydown="if(event.key==='Enter')sendChat()"/>
          <button class="send-btn" id="sendBtn" onclick="sendChat()">Send ⟶</button>
        </div>
      </div>

      <!-- RIGHT PANELS -->
      <div class="right-panels">
        <!-- Live activity -->
        <div class="info-panel flex1">
          <div class="panel-header">
            <span style="color:var(--working)">∿</span>
            <strong>Live Activity</strong>
            <span style="margin-left:auto;font-size:10px" id="activityCount">0 events</span>
          </div>
          <div class="activity-list" id="activityList">
            <div class="empty-state">
              <div class="empty-icon">∿</div>
              <div>Waiting for events...</div>
              <div style="font-size:10px;color:var(--muted2)">Connect to see live data</div>
            </div>
          </div>
          <div class="stats-row">
            <div class="stat-cell">
              <div class="stat-label">Sessions</div>
              <div class="stat-value accent" id="statSessions">—</div>
            </div>
            <div class="stat-cell">
              <div class="stat-label">Model</div>
              <div class="stat-value" style="font-size:12px;color:var(--working)" id="statModel">GPT</div>
            </div>
          </div>
        </div>

        <!-- Sessions panel -->
        <div class="info-panel" style="height:180px">
          <div class="panel-header">
            <span>◈</span>
            <strong>Sessions</strong>
            <span style="margin-left:auto" id="sessionSpinner"></span>
          </div>
          <div id="sessionsList" style="overflow-y:auto;flex:1">
            <div class="empty-state" style="padding:16px">
              <div class="empty-icon">◈</div>
              <div>No sessions</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM TABS -->
<div class="bottom-tabs">
  <div class="tab active">Main Office</div>
  <div class="tab">Workspace</div>
  <div class="tab">Memory</div>
  <div class="tab">Tools</div>
  <div class="tab">Logs</div>
  <div style="margin-left:auto;font-size:10px;color:var(--muted2)" id="modelBadge">gpt-5.1-codex · Berlin</div>
</div>

<script>
// ============================================================
// CONFIG — update these after nginx is live
// ============================================================
const CONFIG = {
  apiBase: 'https://api.pairadice.tech',
  wsBase: 'wss://api.pairadice.tech',
  token: '73fb709fb91dc21dc05a92f22f41f5d1b871ebdd9c405c07',
  // For local testing before nginx: use these instead:
  // apiBase: 'http://127.0.0.1:18789',
  // wsBase: 'ws://127.0.0.1:18789',
};

// ============================================================
// STATE
// ============================================================
let ws = null;
let paused = false;
let activityLog = [];
let agents = [];
let sessions = [];
let startTime = Date.now();
let wsMessages = [];

const DESK_POSITIONS = [
  {x:8,y:10},{x:16,y:10},{x:24,y:10},{x:32,y:10},
  {x:8,y:20},{x:16,y:20},{x:32,y:20},
  {x:40,y:30},
];

const PAIRADICE_AGENT = {
  id: 'main',
  name: 'Pairadice',
  color: '#00e5ff',
  accent: '#0099bb',
  x: 12, y: 8,
  status: 'idle',
  model: 'gpt-5.1-codex',
};

// ============================================================
// INIT
// ============================================================
window.onload = () => {
  renderFloor();
  renderAgent(PAIRADICE_AGENT);
  updateCounts();
  fetchHealth();
  fetchSessions();
  connectWS();
  startUptimeClock();
};

// ============================================================
// FLOOR RENDERING
// ============================================================
function renderFloor() {
  const floor = document.getElementById('officeFloor');
  DESK_POSITIONS.forEach(d => {
    const desk = document.createElement('div');
    desk.className = 'desk';
    desk.style.left = `${d.x * 16}px`;
    desk.style.top = `${d.y * 8}px`;
    desk.innerHTML = renderDeskSVG();
    floor.appendChild(desk);
  });
}

function renderDeskSVG() {
  return `<svg width="56" height="44" viewBox="0 0 56 44" style="image-rendering:pixelated">
    <rect x="4" y="12" width="48" height="22" fill="#0c1a30" rx="3"/>
    <rect x="4" y="12" width="48" height="4" fill="#112240" rx="2"/>
    <rect x="18" y="4" width="20" height="12" fill="#070d1e" rx="2"/>
    <rect x="19" y="5" width="18" height="10" fill="#0a1832" rx="1"/>
    <rect x="20" y="6" width="16" height="8" fill="#00e5ff" opacity="0.15"/>
    <rect x="10" y="32" width="4" height="10" fill="#070d1e" rx="1"/>
    <rect x="42" y="32" width="4" height="10" fill="#070d1e" rx="1"/>
  </svg>`;
}

function renderAgent(agent) {
  const floor = document.getElementById('officeFloor');
  const existing = document.getElementById(`agent-${agent.id}`);
  if (existing) existing.remove();

  const div = document.createElement('div');
  div.className = 'agent';
  div.id = `agent-${agent.id}`;
  div.style.left = `${agent.x * 28}px`;
  div.style.top = `${agent.y * 24}px`;

  const statusColor = agent.status === 'working' ? '#10b981'
    : agent.status === 'chatting' ? '#60a5fa'
    : agent.status === 'busy' ? '#f59e0b'
    : '#4a6080';

  div.innerHTML = `
    <div class="agent-tooltip">
      <div class="tooltip-name" style="color:${agent.color}">${agent.name}</div>
      <div class="tooltip-row">Status: <span>${agent.status}</span></div>
      <div class="tooltip-row">Model: <span>${agent.model || 'gpt-5.1-codex'}</span></div>
      <div class="tooltip-row">ID: <span>${agent.id}</span></div>
    </div>
    <div class="agent-body" style="position:relative">
      <div class="agent-status-ring" style="background:${statusColor};color:${statusColor}"></div>
      ${renderAgentSVG(agent)}
    </div>
    <div class="agent-label">${agent.name}</div>
  `;
  floor.appendChild(div);
}

function renderAgentSVG(agent) {
  const c = agent.color;
  const a = agent.accent || '#0099bb';
  return `<svg width="36" height="46" viewBox="0 0 32 40" style="image-rendering:pixelated">
    <rect x="10" y="14" width="12" height="14" fill="${c}" rx="2"/>
    <rect x="9" y="4" width="14" height="13" fill="${c}" rx="3"/>
    <rect x="12" y="8" width="3" height="3" fill="#000" rx="1"/>
    <rect x="18" y="8" width="3" height="3" fill="#000" rx="1"/>
    <rect x="13" y="8" width="1" height="1" fill="#fff"/>
    <rect x="19" y="8" width="1" height="1" fill="#fff"/>
    <rect x="15" y="1" width="2" height="4" fill="${a}"/>
    <rect x="14" y="0" width="4" height="2" fill="${a}" rx="1"/>
    <rect x="4" y="15" width="6" height="4" fill="${a}" rx="2"/>
    <rect x="22" y="15" width="6" height="4" fill="${a}" rx="2"/>
    <rect x="10" y="27" width="5" height="8" fill="${a}" rx="2"/>
    <rect x="17" y="27" width="5" height="8" fill="${a}" rx="2"/>
    <rect x="3" y="18" width="2" height="3" fill="${c}" rx="1"/>
    <rect x="27" y="18" width="2" height="3" fill="${c}" rx="1"/>
  </svg>`;
}

function moveAgent(id, x, y, status) {
  const el = document.getElementById(`agent-${id}`);
  if (!el) return;
  el.style.left = `${x * 28}px`;
  el.style.top = `${y * 24}px`;
}

// ============================================================
// WEBSOCKET
// ============================================================
function connectWS() {
  setStatus('connecting', 'Connecting...');
  try {
    ws = new WebSocket(`${CONFIG.wsBase}`);
    ws.onopen = () => {
      setStatus('connected', 'Live');
      addActivity('system', 'Connected to Pairadice gateway', 'system');
      addWsMsg('WS connected');
      fetchHealth();
      fetchSessions();
    };
    ws.onmessage = (e) => {
      if (paused) return;
      try {
        const data = JSON.parse(e.data);
        handleWsEvent(data);
      } catch {
        addWsMsg(e.data?.slice(0,60) || 'raw message');
      }
    };
    ws.onerror = () => setStatus('disconnected', 'Error');
    ws.onclose = () => {
      setStatus('disconnected', 'Disconnected');
      setTimeout(connectWS, 5000);
    };
  } catch(e) {
    setStatus('disconnected', 'Failed');
    setTimeout(connectWS, 5000);
  }
}

function handleWsEvent(data) {
  const type = data.type || data.event || 'message';
  const agent = data.agent || data.agentId || 'Pairadice';
  const text = data.text || data.message || data.content || JSON.stringify(data).slice(0,80);

  addActivity(agent, text, type);
  addWsMsg(`[${type}] ${text?.slice(0,40)}`);

  // Update agent status if status event
  if (type === 'agent.status' || type === 'status') {
    PAIRADICE_AGENT.status = data.status || 'working';
    renderAgent(PAIRADICE_AGENT);
  }

  // Animate agent movement
  if (type === 'agent.working' || type === 'task.start') {
    PAIRADICE_AGENT.status = 'working';
    const nx = 4 + Math.floor(Math.random() * 12);
    const ny = 4 + Math.floor(Math.random() * 8);
    moveAgent('main', nx, ny, 'working');
    renderAgent({...PAIRADICE_AGENT, x:nx, y:ny, status:'working'});
  }

  updateLastUpdate();
  updateCounts();
}

function reconnect() {
  if (ws) ws.close();
  connectWS();
}

// ============================================================
// API CALLS
// ============================================================
const headers = {
  'Authorization': `Bearer ${CONFIG.token}`,
  'Content-Type': 'application/json',
};

async function fetchHealth() {
  try {
    const res = await fetch(`${CONFIG.apiBase}/cli/health`, { headers });
    if (res.ok) {
      const data = await res.json();
      document.getElementById('healthGateway').textContent = 'Online';
      document.getElementById('healthGateway').className = 'val good';
      if (data.model) {
        document.getElementById('healthModel').textContent = data.model;
        document.getElementById('statModel').textContent = data.model;
      }
      addActivity('System', 'Health check passed', 'health');
      setStatus('connected', 'Live');
    }
  } catch(e) {
    document.getElementById('healthGateway').textContent = 'Offline';
    document.getElementById('healthGateway').className = 'val bad';
  }
}

async function fetchSessions() {
  const spinner = document.getElementById('sessionSpinner');
  spinner.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`${CONFIG.apiBase}/cli/sessions`, { headers });
    if (res.ok) {
      const data = await res.json();
      sessions = Array.isArray(data) ? data : (data.sessions || []);
      renderSessions();
      document.getElementById('healthSessions').textContent = sessions.length;
      document.getElementById('statSessions').textContent = sessions.length;
    }
  } catch(e) {
    document.getElementById('sessionsList').innerHTML = `
      <div class="empty-state" style="padding:16px">
        <div class="empty-icon">✕</div>
        <div style="color:var(--error)">Cannot reach gateway</div>
        <div style="font-size:10px">Check nginx config</div>
      </div>`;
  } finally {
    spinner.innerHTML = '';
  }
}

function renderSessions() {
  const list = document.getElementById('sessionsList');
  if (!sessions.length) {
    list.innerHTML = `<div class="empty-state" style="padding:16px"><div class="empty-icon">◈</div><div>No active sessions</div></div>`;
    return;
  }
  list.innerHTML = sessions.map(s => `
    <div class="session-item">
      <div class="session-dot" style="background:var(--working)"></div>
      <div class="session-name">${s.id || s.name || 'Session'}</div>
      <div class="session-model">${s.model || 'gpt'}</div>
    </div>
  `).join('');
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  document.getElementById('sendBtn').disabled = true;

  addActivity('You → Pairadice', msg, 'outgoing');
  PAIRADICE_AGENT.status = 'working';
  renderAgent({...PAIRADICE_AGENT, status:'working'});

  try {
    const res = await fetch(`${CONFIG.apiBase}/chat`, {
      method: 'POST',
      headers,
      body: JSON.stringify({ message: msg, agentId: 'main' }),
    });
    if (res.ok) {
      const data = await res.json();
      const reply = data.text || data.message || data.response || '(no response)';
      addActivity('Pairadice', reply, 'response');
      PAIRADICE_AGENT.status = 'idle';
      renderAgent({...PAIRADICE_AGENT, status:'idle'});
    } else {
      addActivity('System', `Chat returned ${res.status}`, 'error');
    }
  } catch(e) {
    addActivity('System', 'Chat failed — check API connection', 'error');
  } finally {
    document.getElementById('sendBtn').disabled = false;
  }
}

function sendMessage(type) {
  addActivity('System', `Sending ${type} command...`, 'command');
  if (type === 'ping') fetchHealth();
  if (type === 'status') fetchSessions();
}

// ============================================================
// ACTIVITY LOG
// ============================================================
function addActivity(agent, text, type) {
  const entry = { agent, text, type, time: new Date() };
  activityLog.unshift(entry);
  if (activityLog.length > 50) activityLog.pop();
  renderActivity();
  document.getElementById('activityCount').textContent = `${activityLog.length} events`;
}

function renderActivity() {
  const list = document.getElementById('activityList');
  if (!activityLog.length) return;
  list.innerHTML = activityLog.slice(0, 20).map(e => {
    const color = e.type === 'error' ? 'var(--error)'
      : e.type === 'health' ? 'var(--working)'
      : e.type === 'response' ? 'var(--accent)'
      : e.type === 'system' ? 'var(--warn)'
      : e.type === 'outgoing' ? '#a78bfa'
      : 'var(--muted)';
    const timeStr = e.time.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    return `
      <div class="activity-item">
        <div class="activity-header">
          <div class="status-dot" style="background:${color};color:${color};width:6px;height:6px;border-radius:50%;flex-shrink:0"></div>
          <span class="activity-agent" style="color:${color}">${e.agent}</span>
          <span class="activity-time">${timeStr}</span>
        </div>
        <div class="activity-text">${e.text?.slice(0,80)}${e.text?.length > 80 ? '...' : ''}</div>
      </div>`;
  }).join('');
}

// ============================================================
// WS FEED OVERLAY
// ============================================================
function addWsMsg(text) {
  const feed = document.getElementById('wsFeed');
  const msg = document.createElement('div');
  msg.className = 'ws-msg';
  msg.innerHTML = `<span class="hi">ws</span> ${text}`;
  feed.prepend(msg);
  if (feed.children.length > 4) feed.removeChild(feed.lastChild);
  setTimeout(() => msg.remove(), 4000);
}

// ============================================================
// HELPERS
// ============================================================
function setStatus(state, label) {
  const pill = document.getElementById('connStatus');
  const lbl = document.getElementById('connLabel');
  pill.className = `status-pill ${state}`;
  lbl.textContent = label;
  document.getElementById('floorStatus').textContent = state === 'connected' ? '● Live' : '○ Offline';
  document.getElementById('floorStatus').style.color = state === 'connected' ? 'var(--working)' : 'var(--error)';
}

function updateCounts() {
  const working = agents.filter(a => a.status === 'working').length + (PAIRADICE_AGENT.status === 'working' ? 1 : 0);
  const chatting = agents.filter(a => a.status === 'chatting').length + (PAIRADICE_AGENT.status === 'chatting' ? 1 : 0);
  const idle = (PAIRADICE_AGENT.status === 'idle' ? 1 : 0);
  document.getElementById('countWorking').textContent = working;
  document.getElementById('countChatting').textContent = chatting;
  document.getElementById('countIdle').textContent = idle;
}

function updateLastUpdate() {
  document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString('de-DE')}`;
}

function startUptimeClock() {
  setInterval(() => {
    const s = Math.floor((Date.now() - startTime) / 1000);
    const m = Math.floor(s / 60);
    const h = Math.floor(m / 60);
    document.getElementById('healthUptime').textContent = h > 0 ? `${h}h ${m%60}m` : `${m}m ${s%60}s`;
  }, 1000);
}

function togglePause() {
  paused = !paused;
  const btn = document.getElementById('pauseBtn');
  btn.textContent = paused ? '▶ Resume' : '⏸ Pause';
  btn.className = paused ? 'topbar-btn active' : 'topbar-btn';
}

function setTab(tab) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.nav-item').classList.add('active');
}
</script>
</body>
</html>
